<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 Dataset Download</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: #f0f4f8; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; min-height: 100vh; }
        
        /* Logo Box */
        .logo-box { background: #f8f9fa; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid #004080; }
        .logo-box img { width: 80px; height: auto; border-radius: 6px; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #004080; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .required { color: #dc3545; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; color: #000; background: #ffffff; transition: all 0.3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
        .form-input::placeholder { color: #999; }
        .help-text { font-size: 12px; color: #666; margin-top: 5px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Buttons */
        .btn-primary { width: 100%; padding: 14px 24px; background: #004080; color: #ffffff; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .btn-primary:disabled { background: #6c757d; border-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { padding: 12px 20px; background: #ffffff; color: #004080; border: 2px solid #004080; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-secondary:hover { background: #004080; color: #ffffff; }
        .btn-gold { padding: 14px 24px; background: #ffc107; color: #000000; border: 2px solid #ffc107; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-gold:hover { background: #e0a800; border-color: #e0a800; }
        
        /* Main Content */
        .main-content { display: block; padding: 20px; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .page-header .logo-box { background: #ffffff; border: none; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; color: #ffffff; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; color: #ffffff; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; color: #ffffff; font-weight: 500; }
        
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
        
        /* Dual Panel Container */
        .dual-panel-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .panel { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; overflow: hidden; }
        .panel-header { background: #004080; color: white; padding: 12px 15px; }
        .panel-title { font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .panel-count { background: #ffffff; color: #004080; padding: 2px 10px; border-radius: 12px; font-size: 11px; }
        .panel-action-btn { width: 100%; padding: 10px; border: none; font-family: 'Oswald', Arial, sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; }
        .load-btn { background: #ffc107; color: #000; }
        .load-btn:hover { background: #e0a800; }
        .add-all-btn { background: #28a745; color: white; }
        .add-all-btn:hover { background: #218838; }
        .clear-all-btn { background: #dc3545; color: white; }
        .clear-all-btn:hover { background: #c82333; }
        .search-box { width: 100%; padding: 10px 15px; border: none; border-bottom: 2px solid #004080; font-family: 'Oswald', Arial, sans-serif; font-size: 13px; }
        .search-box:focus { outline: none; background: #e7f3ff; }
        .panel-content { max-height: 300px; overflow-y: auto; padding: 10px; }
        .panel-item { padding: 8px 12px; margin: 4px 0; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .panel-item:hover { background: #e7f3ff; border-color: #004080; }
        .panel-item.selected { background: #d4edda; border-color: #28a745; }
        .panel-item input[type="checkbox"] { accent-color: #004080; }
        
        /* Organisation Unit Tree */
        .org-unit-tree { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 15px; max-height: 350px; overflow-y: auto; margin-bottom: 15px; }
        .org-unit-item { padding: 6px 10px; margin: 2px 0; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .org-unit-item:hover { background: #e7f3ff; }
        .org-unit-item.selected { background: #d4edda; }
        .org-unit-toggle { width: 20px; text-align: center; font-weight: bold; color: #004080; }
        .org-unit-children { margin-left: 25px; display: none; }
        .org-unit-children.expanded { display: block; }
        .control-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .control-btn { padding: 8px 16px; border: 2px solid #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: white; color: #004080; }
        .control-btn:hover { background: #004080; color: white; }
        .control-btn.expand { border-color: #17a2b8; color: #17a2b8; }
        .control-btn.expand:hover { background: #17a2b8; color: white; }
        .control-btn.select-all { border-color: #28a745; color: #28a745; }
        .control-btn.select-all:hover { background: #28a745; color: white; }
        .control-btn.clear { border-color: #dc3545; color: #dc3545; }
        .control-btn.clear:hover { background: #dc3545; color: white; }
        
        /* Period Selector */
        .period-selector { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .period-type-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .period-tab { padding: 10px 20px; background: white; border: 2px solid #004080; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s; }
        .period-tab:hover { background: #e7f3ff; }
        .period-tab.active { background: #004080; color: white; }
        .period-inputs { display: none; }
        .period-inputs.active { display: block; }
        
        /* Progress Section */
        .progress-section { display: none; background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .progress-section.active { display: block; }
        .progress-bar { height: 25px; background: #e9ecef; border-radius: 6px; overflow: hidden; border: 2px solid #004080; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #004080, #0066cc); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; }
        .log-container { margin-top: 15px; max-height: 200px; overflow-y: auto; background: #1a1a2e; border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #333; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }
        
        /* Notification */
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; font-weight: 600; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .notification.success { background: #d4edda; color: #155724; border: 2px solid #28a745; display: block; }
        .notification.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; display: block; }
        .notification.info { background: #e7f3ff; color: #004080; border: 2px solid #004080; display: block; }
        
        /* Footer */
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; font-weight: 500; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; color: #ffffff; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f8f9fa; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #004080; border-radius: 4px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dual-panel-container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .period-type-tabs { flex-direction: column; }
            .control-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="page-container">
            <div class="page-header">
                <div class="logo-row">
                    <div class="logo-box">
                        <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo" class="logo-img" style="width: 100px;">
                    </div>
                </div>
                <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
                <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
                <h1>DHIS2 DATASET DOWNLOAD TOOL</h1>
                <p class="subtitle">Export Datasets with Data Values in Excel-Ready Wide CSV Format</p>
            </div>

            <div class="content-card">
                <div class="content-inner">
                    <!-- Data Elements Section -->
                    <div class="section-header">
                        <span class="section-icon">1</span>
                        <span class="section-title">SELECT DATA ELEMENTS</span>
                    </div>

                    <div class="dual-panel-container">
                        <div class="panel">
                            <div class="panel-header">
                                <div class="panel-title">
                                    Available Items
                                    <span class="panel-count" id="availableCount">0 items</span>
                                </div>
                            </div>
                            <button type="button" class="panel-action-btn load-btn" onclick="loadDatasetsWithElements()">
                                Load Items
                            </button>
                            <input type="text" class="search-box" id="availableSearch" placeholder="Search available items..." onkeyup="filterAvailableItems()" style="display: none;">
                            <button type="button" class="panel-action-btn add-all-btn" onclick="addAllItems()" style="display: none;" id="addAllBtn">
                                Add All
                            </button>
                            <div class="panel-content" id="availablePanel">
                                <p style="color: #666; text-align: center; padding: 20px;">Click "Load Items" to fetch data elements...</p>
                            </div>
                        </div>

                        <div class="panel">
                            <div class="panel-header">
                                <div class="panel-title">
                                    Selected Items
                                    <span class="panel-count" id="selectedCount">0 items</span>
                                </div>
                            </div>
                            <input type="text" class="search-box" id="selectedSearch" placeholder="Search selected items..." onkeyup="filterSelectedItems()">
                            <button type="button" class="panel-action-btn clear-all-btn" onclick="clearAllItems()">
                                Clear All
                            </button>
                            <div class="panel-content" id="selectedPanel">
                                <p style="color: #666; text-align: center; padding: 20px;">No items selected yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Organisation Units Section -->
                    <div class="section-header" style="margin-top: 30px;">
                        <span class="section-icon">2</span>
                        <span class="section-title">SELECT ORGANISATION UNITS</span>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn-secondary" onclick="loadOrgUnitsTree()" style="width: auto;">
                            Load Organisation Units
                        </button>
                    </div>
                    <div class="org-unit-tree" id="orgUnitTree">
                        <p style="color: #666; text-align: center;">Click "Load Organisation Units" to fetch...</p>
                    </div>
                    <div class="control-buttons">
                        <button type="button" class="control-btn expand" onclick="expandAllOrgUnits()">Expand All</button>
                        <button type="button" class="control-btn clear" onclick="collapseAllOrgUnits()">Collapse All</button>
                        <button type="button" class="control-btn select-all" onclick="selectAllOrgUnits()">Select All</button>
                        <button type="button" class="control-btn clear" onclick="clearAllOrgUnits()">Clear All</button>
                    </div>

                    <!-- Period Section -->
                    <div class="section-header" style="margin-top: 30px;">
                        <span class="section-icon">3</span>
                        <span class="section-title">SELECT PERIOD</span>
                    </div>

                    <div class="period-selector">
                        <label class="form-label">Select Period Type</label>
                        <div class="period-type-tabs">
                            <div class="period-tab active" onclick="selectPeriodType('monthly')">Monthly</div>
                            <div class="period-tab" onclick="selectPeriodType('range')">Date Range</div>
                            <div class="period-tab" onclick="selectPeriodType('quarterly')">Quarterly</div>
                            <div class="period-tab" onclick="selectPeriodType('yearly')">Yearly</div>
                        </div>

                        <div class="period-inputs active" id="monthly-inputs">
                            <div class="form-group">
                                <label class="form-label">Year-Month</label>
                                <input type="month" class="form-input" name="period" id="periodMonth">
                            </div>
                        </div>

                        <div class="period-inputs" id="range-inputs">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Month</label>
                                    <input type="month" class="form-input" name="periodStart" id="periodStart">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Month</label>
                                    <input type="month" class="form-input" name="periodEnd" id="periodEnd">
                                </div>
                            </div>
                        </div>

                        <div class="period-inputs" id="quarterly-inputs">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Year</label>
                                    <input type="number" class="form-input" name="year" id="quarterYear" min="2000" max="2030" value="2025">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quarter</label>
                                    <select class="form-select" name="quarter" id="quarter">
                                        <option value="Q1">Q1 (Jan-Mar)</option>
                                        <option value="Q2">Q2 (Apr-Jun)</option>
                                        <option value="Q3">Q3 (Jul-Sep)</option>
                                        <option value="Q4">Q4 (Oct-Dec)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="period-inputs" id="yearly-inputs">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Year</label>
                                    <input type="number" class="form-input" name="startYear" id="startYear" min="2000" max="2030" placeholder="Start Year">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Year</label>
                                    <input type="number" class="form-input" name="endYear" id="endYear" min="2000" max="2030" placeholder="End Year">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-section" id="progressSection">
                        <div class="section-header">
                            <span class="section-icon">4</span>
                            <span class="section-title">DOWNLOAD PROGRESS</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                        </div>
                        <div class="log-container" id="logContainer"></div>
                    </div>

                    <!-- Download Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn-gold" id="downloadDatasetsBtn" onclick="executeDownloadDatasets()" style="padding: 16px 40px; font-size: 16px;">
                            DOWNLOAD DATASET DATA
                        </button>
                    </div>
                </div>
            </div>

            <div class="page-footer">
                <p style="margin: 0; font-weight: 700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
                <p>Driving Data-Driven Solutions for Health and Development</p>
                <p style="font-size: 10px;">Â© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // State Management - Pre-configured credentials
        let dhis2Config = { 
            url: 'https://sl.dhis2.org/hmis23', 
            auth: btoa('musa-sillahkanu:Navigator/2024!') 
        };
        let availableItems = [];
        let selectedItems = [];
        let orgUnits = [];
        let selectedOrgUnits = [];
        let currentPeriodType = 'monthly';

        // Auto-connect on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch(dhis2Config.url + '/api/me', {
                    headers: { 'Authorization': 'Basic ' + dhis2Config.auth }
                });
                
                if (response.ok) {
                    document.getElementById('mainContent').classList.add('active');
                    showNotification('Connected to DHIS2 successfully!', 'success');
                } else {
                    showNotification('Connection failed. Please check credentials.', 'error');
                }
            } catch (error) {
                showNotification('Connection error: ' + error.message, 'error');
            }
        });

        // Period Type Selection
        function selectPeriodType(type) {
            currentPeriodType = type;
            document.querySelectorAll('.period-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.period-inputs').forEach(input => input.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(type + '-inputs').classList.add('active');
        }

        // Load Datasets with Elements
        async function loadDatasetsWithElements() {
            try {
                showNotification('Loading data elements...', 'info');
                
                const response = await fetch(dhis2Config.url + '/api/dataElements.json?paging=false&fields=id,name,displayName', {
                    headers: { 'Authorization': 'Basic ' + dhis2Config.auth }
                });
                
                if (!response.ok) throw new Error('Failed to load data elements');
                
                const data = await response.json();
                availableItems = data.dataElements || [];
                
                renderAvailableItems();
                document.getElementById('availableSearch').style.display = 'block';
                document.getElementById('addAllBtn').style.display = 'block';
                document.getElementById('availableCount').textContent = availableItems.length + ' items';
                
                showNotification('Loaded ' + availableItems.length + ' data elements', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Render Available Items
        function renderAvailableItems() {
            const panel = document.getElementById('availablePanel');
            const searchTerm = document.getElementById('availableSearch').value.toLowerCase();
            
            const filtered = availableItems.filter(item => 
                !selectedItems.find(s => s.id === item.id) &&
                (item.displayName || item.name).toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                panel.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No items found</p>';
                return;
            }
            
            panel.innerHTML = filtered.map(item => `
                <div class="panel-item" onclick="selectItem('${item.id}')">
                    <input type="checkbox" id="avail-${item.id}">
                    <label>${item.displayName || item.name}</label>
                </div>
            `).join('');
        }

        // Render Selected Items
        function renderSelectedItems() {
            const panel = document.getElementById('selectedPanel');
            const searchTerm = document.getElementById('selectedSearch').value.toLowerCase();
            
            const filtered = selectedItems.filter(item => 
                (item.displayName || item.name).toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                panel.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No items selected</p>';
                return;
            }
            
            panel.innerHTML = filtered.map(item => `
                <div class="panel-item selected" onclick="deselectItem('${item.id}')">
                    <input type="checkbox" checked>
                    <label>${item.displayName || item.name}</label>
                </div>
            `).join('');
            
            document.getElementById('selectedCount').textContent = selectedItems.length + ' items';
        }

        // Select Item
        function selectItem(id) {
            const item = availableItems.find(i => i.id === id);
            if (item && !selectedItems.find(s => s.id === id)) {
                selectedItems.push(item);
                renderAvailableItems();
                renderSelectedItems();
            }
        }

        // Deselect Item
        function deselectItem(id) {
            selectedItems = selectedItems.filter(item => item.id !== id);
            renderAvailableItems();
            renderSelectedItems();
        }

        // Add All Items
        function addAllItems() {
            const searchTerm = document.getElementById('availableSearch').value.toLowerCase();
            const filtered = availableItems.filter(item => 
                !selectedItems.find(s => s.id === item.id) &&
                (item.displayName || item.name).toLowerCase().includes(searchTerm)
            );
            selectedItems = [...selectedItems, ...filtered];
            renderAvailableItems();
            renderSelectedItems();
        }

        // Clear All Items
        function clearAllItems() {
            selectedItems = [];
            renderAvailableItems();
            renderSelectedItems();
        }

        // Filter Functions
        function filterAvailableItems() { renderAvailableItems(); }
        function filterSelectedItems() { renderSelectedItems(); }

        // Load Organisation Units Tree
        async function loadOrgUnitsTree() {
            try {
                showNotification('Loading organisation units...', 'info');
                
                const response = await fetch(dhis2Config.url + '/api/organisationUnits.json?paging=false&fields=id,name,displayName,level,parent[id]&order=level:asc,name:asc', {
                    headers: { 'Authorization': 'Basic ' + dhis2Config.auth }
                });
                
                if (!response.ok) throw new Error('Failed to load org units');
                
                const data = await response.json();
                orgUnits = data.organisationUnits || [];
                
                renderOrgUnitTree();
                showNotification('Loaded ' + orgUnits.length + ' organisation units', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Render Org Unit Tree (simplified flat list with levels)
        function renderOrgUnitTree() {
            const container = document.getElementById('orgUnitTree');
            
            if (orgUnits.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No organisation units found</p>';
                return;
            }
            
            container.innerHTML = orgUnits.map(ou => `
                <div class="org-unit-item" style="padding-left: ${(ou.level - 1) * 20}px;" onclick="toggleOrgUnit('${ou.id}')" id="ou-${ou.id}">
                    <input type="checkbox" ${selectedOrgUnits.includes(ou.id) ? 'checked' : ''}>
                    <span>${ou.displayName || ou.name}</span>
                </div>
            `).join('');
        }

        // Toggle Org Unit Selection
        function toggleOrgUnit(id) {
            if (selectedOrgUnits.includes(id)) {
                selectedOrgUnits = selectedOrgUnits.filter(ou => ou !== id);
                document.getElementById('ou-' + id).classList.remove('selected');
            } else {
                selectedOrgUnits.push(id);
                document.getElementById('ou-' + id).classList.add('selected');
            }
        }

        // Org Unit Controls
        function expandAllOrgUnits() {
            document.querySelectorAll('.org-unit-children').forEach(el => el.classList.add('expanded'));
        }
        function collapseAllOrgUnits() {
            document.querySelectorAll('.org-unit-children').forEach(el => el.classList.remove('expanded'));
        }
        function selectAllOrgUnits() {
            selectedOrgUnits = orgUnits.map(ou => ou.id);
            document.querySelectorAll('.org-unit-item').forEach(el => el.classList.add('selected'));
            document.querySelectorAll('.org-unit-item input').forEach(cb => cb.checked = true);
        }
        function clearAllOrgUnits() {
            selectedOrgUnits = [];
            document.querySelectorAll('.org-unit-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.org-unit-item input').forEach(cb => cb.checked = false);
        }

        // Get Period String
        function getPeriodString() {
            switch (currentPeriodType) {
                case 'monthly':
                    const month = document.getElementById('periodMonth').value;
                    return month ? month.replace('-', '') : '';
                case 'range':
                    const start = document.getElementById('periodStart').value;
                    const end = document.getElementById('periodEnd').value;
                    if (!start || !end) return '';
                    // Generate array of months between start and end
                    const periods = [];
                    let current = new Date(start + '-01');
                    const endDate = new Date(end + '-01');
                    while (current <= endDate) {
                        periods.push(current.getFullYear() + String(current.getMonth() + 1).padStart(2, '0'));
                        current.setMonth(current.getMonth() + 1);
                    }
                    return periods.join(';');
                case 'quarterly':
                    const year = document.getElementById('quarterYear').value;
                    const quarter = document.getElementById('quarter').value;
                    return year + quarter;
                case 'yearly':
                    const startYear = document.getElementById('startYear').value;
                    const endYear = document.getElementById('endYear').value;
                    if (!startYear) return '';
                    if (!endYear || endYear === startYear) return startYear;
                    const years = [];
                    for (let y = parseInt(startYear); y <= parseInt(endYear); y++) {
                        years.push(y.toString());
                    }
                    return years.join(';');
                default:
                    return '';
            }
        }

        // Execute Download
        async function executeDownloadDatasets() {
            if (selectedItems.length === 0) {
                showNotification('Please select at least one data element', 'error');
                return;
            }
            if (selectedOrgUnits.length === 0) {
                showNotification('Please select at least one organisation unit', 'error');
                return;
            }
            
            const period = getPeriodString();
            if (!period) {
                showNotification('Please select a valid period', 'error');
                return;
            }

            document.getElementById('progressSection').classList.add('active');
            const logContainer = document.getElementById('logContainer');
            const progressFill = document.getElementById('progressFill');
            logContainer.innerHTML = '';

            try {
                addLog('Starting data download...', 'info');
                progressFill.style.width = '10%';
                progressFill.textContent = '10%';

                const dataElementIds = selectedItems.map(i => i.id).join(';');
                const orgUnitIds = selectedOrgUnits.join(';');
                const periods = period.split(';');

                addLog('Fetching data for ' + selectedItems.length + ' elements, ' + selectedOrgUnits.length + ' org units...', 'info');
                progressFill.style.width = '30%';
                progressFill.textContent = '30%';

                const url = `${dhis2Config.url}/api/analytics.json?dimension=dx:${dataElementIds}&dimension=ou:${orgUnitIds}&dimension=pe:${periods.join(';')}&skipMeta=false`;
                
                addLog('API URL: ' + url.substring(0, 100) + '...', 'info');

                const response = await fetch(url, {
                    headers: { 'Authorization': 'Basic ' + dhis2Config.auth }
                });

                if (!response.ok) {
                    throw new Error('API request failed: ' + response.status);
                }

                const data = await response.json();
                addLog('Received ' + (data.rows ? data.rows.length : 0) + ' data rows', 'success');
                progressFill.style.width = '70%';
                progressFill.textContent = '70%';

                // Convert to wide format CSV
                addLog('Converting to wide CSV format...', 'info');
                const csv = convertToWideCSV(data);
                
                progressFill.style.width = '90%';
                progressFill.textContent = '90%';

                // Download CSV
                downloadCSV(csv, 'dhis2_dataset_' + new Date().toISOString().slice(0, 10) + '.csv');
                
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                addLog('Download complete!', 'success');
                showNotification('Data downloaded successfully!', 'success');

            } catch (error) {
                addLog('Error: ' + error.message, 'error');
                showNotification('Download failed: ' + error.message, 'error');
            }
        }

        // Convert Analytics Data to Wide CSV
        function convertToWideCSV(data) {
            if (!data.rows || data.rows.length === 0) {
                return 'No data available';
            }

            const headers = data.headers || [];
            const metaData = data.metaData || {};
            const items = metaData.items || {};

            // Get dimension indices
            const dxIndex = headers.findIndex(h => h.name === 'dx');
            const ouIndex = headers.findIndex(h => h.name === 'ou');
            const peIndex = headers.findIndex(h => h.name === 'pe');
            const valueIndex = headers.findIndex(h => h.name === 'value');

            // Group by org unit and period
            const grouped = {};
            const allDataElements = new Set();

            data.rows.forEach(row => {
                const ou = row[ouIndex];
                const pe = row[peIndex];
                const dx = row[dxIndex];
                const value = row[valueIndex];

                const key = ou + '|' + pe;
                if (!grouped[key]) {
                    grouped[key] = { ou, pe, values: {} };
                }
                grouped[key].values[dx] = value;
                allDataElements.add(dx);
            });

            // Build CSV
            const dataElementList = Array.from(allDataElements);
            const csvHeaders = ['Organisation Unit', 'Period', ...dataElementList.map(dx => items[dx]?.name || dx)];
            
            const csvRows = Object.values(grouped).map(row => {
                const ouName = items[row.ou]?.name || row.ou;
                return [ouName, row.pe, ...dataElementList.map(dx => row.values[dx] || '')];
            });

            // Convert to CSV string
            const csvContent = [csvHeaders, ...csvRows]
                .map(row => row.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(','))
                .join('\n');

            return csvContent;
        }

        // Download CSV File
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Add Log Entry
        function addLog(message, type) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Show Notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 4000);
        }
    </script>
</body>
</html>
