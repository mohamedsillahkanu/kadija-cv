<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 Dataset Download</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: #f0f4f8; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; min-height: 100vh; }
        
        /* Logo Box */
        .logo-box { background: #f8f9fa; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid #004080; }
        .logo-box img { width: 80px; height: auto; border-radius: 6px; }
        
        /* Login Screen */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #004080 0%, #0066cc 100%); }
        .login-card { background: #ffffff; border-radius: 12px; padding: 40px; max-width: 450px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.2); border: 4px double #004080; }
        .logo-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: #004080; font-size: 24px; font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .login-header p { color: #666; font-size: 14px; font-weight: 500; }
        .readonly-input { background: #e9ecef !important; color: #495057 !important; cursor: not-allowed; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #004080; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .required { color: #dc3545; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; color: #000; background: #ffffff; transition: all 0.3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
        .form-input::placeholder { color: #999; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Buttons */
        .btn-primary { width: 100%; padding: 14px 24px; background: #004080; color: #ffffff; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .btn-primary:disabled { background: #6c757d; border-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { padding: 12px 20px; background: #ffffff; color: #004080; border: 2px solid #004080; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-secondary:hover { background: #004080; color: #ffffff; }
        .btn-gold { padding: 14px 24px; background: #ffc107; color: #000000; border: 2px solid #ffc107; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-gold:hover { background: #e0a800; border-color: #e0a800; }
        
        /* Main Content */
        .main-content { display: none; padding: 20px; }
        .main-content.active { display: block; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .page-header .logo-box { background: #ffffff; border: none; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; color: #ffffff; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; color: #ffffff; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; color: #ffffff; font-weight: 500; }
        
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
        
        /* Dual Panel Container */
        .dual-panel-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .panel { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; overflow: hidden; }
        .panel-header { background: #004080; color: white; padding: 12px 15px; }
        .panel-title { font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .panel-count { background: #ffffff; color: #004080; padding: 2px 10px; border-radius: 12px; font-size: 11px; }
        .panel-action-btn { width: 100%; padding: 10px; border: none; font-family: 'Oswald', Arial, sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; }
        .load-btn { background: #ffc107; color: #000; }
        .load-btn:hover { background: #e0a800; }
        .add-all-btn { background: #28a745; color: white; }
        .add-all-btn:hover { background: #218838; }
        .clear-all-btn { background: #dc3545; color: white; }
        .clear-all-btn:hover { background: #c82333; }
        .search-box { width: 100%; padding: 10px 15px; border: none; border-bottom: 2px solid #004080; font-family: 'Oswald', Arial, sans-serif; font-size: 13px; }
        .search-box:focus { outline: none; background: #e7f3ff; }
        .panel-content { max-height: 350px; overflow-y: auto; padding: 10px; }
        
        /* Dataset and Element Items */
        .dataset-item { padding: 10px 12px; margin: 4px 0; background: #004080; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .dataset-item:hover { background: #0056b3; }
        .item-toggle { width: 20px; text-align: center; font-weight: bold; }
        .item-name { flex: 1; }
        .data-elements-container { display: none; margin-left: 15px; border-left: 2px solid #004080; padding-left: 10px; }
        .data-elements-container.expanded { display: block; }
        .data-element-item { padding: 8px 12px; margin: 4px 0; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .data-element-item:hover { background: #e7f3ff; border-color: #004080; }
        .add-btn { background: #28a745; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; }
        .add-btn:hover { background: #218838; }
        .selected-item { padding: 8px 12px; margin: 4px 0; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; font-size: 12px; display: flex; align-items: center; justify-content: space-between; }
        .remove-btn { background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1; }
        .remove-btn:hover { background: #c82333; }
        
        /* Organisation Unit Tree */
        .org-unit-tree { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 15px; max-height: 350px; overflow-y: auto; margin-bottom: 15px; }
        .org-unit-item { padding: 6px 10px; margin: 2px 0; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .org-unit-item:hover { background: #e7f3ff; }
        .org-unit-item.selected { background: #d4edda; }
        .org-unit-toggle { width: 20px; text-align: center; font-weight: bold; color: #004080; cursor: pointer; }
        .org-unit-checkbox { accent-color: #004080; }
        .org-unit-label { flex: 1; cursor: pointer; }
        .org-unit-children { margin-left: 25px; display: none; }
        .org-unit-children.expanded { display: block; }
        .control-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .control-btn { padding: 8px 16px; border: 2px solid #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: white; color: #004080; }
        .control-btn:hover { background: #004080; color: white; }
        .control-btn.expand { border-color: #17a2b8; color: #17a2b8; }
        .control-btn.expand:hover { background: #17a2b8; color: white; }
        .control-btn.select-all { border-color: #28a745; color: #28a745; }
        .control-btn.select-all:hover { background: #28a745; color: white; }
        .control-btn.clear { border-color: #dc3545; color: #dc3545; }
        .control-btn.clear:hover { background: #dc3545; color: white; }
        
        /* Period Selector */
        .period-selector { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .period-type-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .period-tab { padding: 10px 20px; background: white; border: 2px solid #004080; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s; }
        .period-tab:hover { background: #e7f3ff; }
        .period-tab.active { background: #004080; color: white; }
        .period-inputs { display: none; }
        .period-inputs.active { display: block; }
        
        /* Progress Section */
        .progress-section { display: none; background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .progress-section.active { display: block; }
        .progress-bar { height: 25px; background: #e9ecef; border-radius: 6px; overflow: hidden; border: 2px solid #004080; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #004080, #0066cc); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; }
        .log-container { margin-top: 15px; max-height: 200px; overflow-y: auto; background: #1a1a2e; border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #333; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }
        
        /* Notification */
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; font-weight: 600; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .notification.success { background: #d4edda; color: #155724; border: 2px solid #28a745; display: block; }
        .notification.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; display: block; }
        .notification.info { background: #e7f3ff; color: #004080; border: 2px solid #004080; display: block; }
        
        /* Footer */
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; font-weight: 500; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; color: #ffffff; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f8f9fa; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #004080; border-radius: 4px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dual-panel-container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .period-type-tabs { flex-direction: column; }
            .control-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo" class="logo-img" style="width: 100px;">
                </div>
            </div>

            <div class="login-header">
                <h1>DHIS2 DATASET DOWNLOAD</h1>
                <p>Export Dataset Data in Wide CSV Format</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">DHIS2 Instance URL</label>
                    <input type="url" class="form-input readonly-input" id="instanceUrl" value="https://sl.dhis2.org/hmis23" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input readonly-input" id="username" value="musa-sillahkanu" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input readonly-input" id="password" value="Navigator/2024!" readonly>
                </div>

                <button type="submit" class="btn-primary">Connect to DHIS2</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="page-container">
            <div class="page-header">
                <div class="logo-row">
                    <div class="logo-box">
                        <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo" class="logo-img" style="width: 100px;">
                    </div>
                </div>
                <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
                <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
                <h1>DHIS2 DATASET DOWNLOAD TOOL</h1>
                <p class="subtitle">Export Datasets with Data Values in Excel-Ready Wide CSV Format</p>
            </div>

            <div class="content-card">
                <div class="content-inner">
                    <!-- Data Elements Section -->
                    <div class="section-header">
                        <span class="section-icon">1</span>
                        <span class="section-title">SELECT DATA ELEMENTS</span>
                    </div>

                    <div class="dual-panel-container">
                        <div class="panel">
                            <div class="panel-header">
                                <div class="panel-title">
                                    Available Items
                                    <span class="panel-count" id="availableCount">0 items</span>
                                </div>
                            </div>
                            <button type="button" class="panel-action-btn load-btn" onclick="loadDatasetsWithElements()">
                                Load Datasets
                            </button>
                            <input type="text" class="search-box" id="availableSearch" placeholder="Search available items..." onkeyup="filterAvailableItems()" style="display: none;">
                            <button type="button" class="panel-action-btn add-all-btn" onclick="addAllItems()" style="display: none;" id="addAllBtn">
                                Add All
                            </button>
                            <div class="panel-content" id="availablePanel">
                                <p style="color: #666; text-align: center; padding: 20px;">Click "Load Datasets" to fetch data elements...</p>
                            </div>
                        </div>

                        <div class="panel">
                            <div class="panel-header">
                                <div class="panel-title">
                                    Selected Items
                                    <span class="panel-count" id="selectedCount">0 items</span>
                                </div>
                            </div>
                            <input type="text" class="search-box" id="selectedSearch" placeholder="Search selected items..." onkeyup="filterSelectedItems()">
                            <button type="button" class="panel-action-btn clear-all-btn" onclick="clearAllItems()">
                                Clear All
                            </button>
                            <div class="panel-content" id="selectedPanel">
                                <p style="color: #666; text-align: center; padding: 20px;">No items selected yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Organisation Units Section -->
                    <div class="section-header" style="margin-top: 30px;">
                        <span class="section-icon">2</span>
                        <span class="section-title">SELECT ORGANISATION UNITS</span>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn-secondary" onclick="loadOrgUnitsTree()" style="width: auto;">
                            Load Organisation Units
                        </button>
                    </div>
                    <div class="org-unit-tree" id="orgUnitTree">
                        <p style="color: #666; text-align: center;">Click "Load Organisation Units" to fetch...</p>
                    </div>
                    <div class="control-buttons">
                        <button type="button" class="control-btn expand" onclick="expandAllOrgUnits()">Expand All</button>
                        <button type="button" class="control-btn clear" onclick="collapseAllOrgUnits()">Collapse All</button>
                        <button type="button" class="control-btn select-all" onclick="selectAllOrgUnits()">Select All</button>
                        <button type="button" class="control-btn clear" onclick="clearAllOrgUnits()">Clear All</button>
                    </div>

                    <!-- Period Section -->
                    <div class="section-header" style="margin-top: 30px;">
                        <span class="section-icon">3</span>
                        <span class="section-title">SELECT PERIOD</span>
                    </div>

                    <div class="period-selector">
                        <label class="form-label">Select Period Type</label>
                        <div class="period-type-tabs">
                            <div class="period-tab active" onclick="selectPeriodType('monthly')">Monthly</div>
                            <div class="period-tab" onclick="selectPeriodType('range')">Date Range</div>
                            <div class="period-tab" onclick="selectPeriodType('quarterly')">Quarterly</div>
                            <div class="period-tab" onclick="selectPeriodType('yearly')">Yearly</div>
                        </div>

                        <div class="period-inputs active" id="monthly-inputs">
                            <div class="form-group">
                                <label class="form-label">Year-Month</label>
                                <input type="month" class="form-input" name="period" id="periodMonth">
                            </div>
                        </div>

                        <div class="period-inputs" id="range-inputs">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Month</label>
                                    <input type="month" class="form-input" name="periodStart" id="periodStart">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Month</label>
                                    <input type="month" class="form-input" name="periodEnd" id="periodEnd">
                                </div>
                            </div>
                        </div>

                        <div class="period-inputs" id="quarterly-inputs">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Year</label>
                                    <input type="number" class="form-input" name="year" id="quarterYear" min="2000" max="2030" value="2025">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quarter</label>
                                    <select class="form-select" name="quarter" id="quarter">
                                        <option value="Q1">Q1 (Jan-Mar)</option>
                                        <option value="Q2">Q2 (Apr-Jun)</option>
                                        <option value="Q3">Q3 (Jul-Sep)</option>
                                        <option value="Q4">Q4 (Oct-Dec)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="period-inputs" id="yearly-inputs">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Year</label>
                                    <input type="number" class="form-input" name="startYear" id="startYear" min="2000" max="2030" placeholder="Start Year">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Year</label>
                                    <input type="number" class="form-input" name="endYear" id="endYear" min="2000" max="2030" placeholder="End Year">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-section" id="progressSection">
                        <div class="section-header">
                            <span class="section-icon">4</span>
                            <span class="section-title">DOWNLOAD PROGRESS</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                        </div>
                        <div class="log-container" id="logContainer"></div>
                    </div>

                    <!-- Download Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn-gold" id="downloadDatasetsBtn" onclick="executeDownloadDatasets()" style="padding: 16px 40px; font-size: 16px;">
                            DOWNLOAD DATASET DATA
                        </button>
                    </div>
                </div>
            </div>

            <div class="page-footer">
                <p style="margin: 0; font-weight: 700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
                <p>Driving Data-Driven Solutions for Health and Development</p>
                <p style="font-size: 10px;">© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Google Apps Script Proxy for CORS bypass
        const GOOGLE_APPS_SCRIPT_PROXY = 'https://script.google.com/macros/s/AKfycbyRXc68PYSmDSCYPakAS8Gc9R00kRjmsMYoDujPYMItyquXfwMAJUtRqXLiDlNWbSfDQQ/exec';
        const state = { config: null, isLoggedIn: false };
        let datasetsData = [];
        let selectedDataElements = new Set();
        let orgUnitsData = [];
        let selectedOrgUnits = new Set();

        function makeProxyRequest(targetUrl, options = {}) {
            let proxyUrl = `${GOOGLE_APPS_SCRIPT_PROXY}?url=${encodeURIComponent(targetUrl)}`;
            if (options.headers && options.headers.Authorization) {
                proxyUrl += `&Authorization=${encodeURIComponent(options.headers.Authorization)}`;
            }
            return fetch(proxyUrl, { method: options.method || 'GET', body: options.body });
        }

        async function fetchWithAuth(url, options = {}) {
            if (!state.config) throw new Error('Not authenticated');
            const authHeader = 'Basic ' + btoa(`${state.config.username}:${state.config.password}`);
            return makeProxyRequest(url, { ...options, headers: { 'Authorization': authHeader, 'Content-Type': 'application/json', ...options.headers } });
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = `notification ${type}`;
            setTimeout(() => { notification.className = 'notification'; }, 4000);
        }

        function setProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = percent + '%';
                progressFill.textContent = percent + '%';
            }
        }

        function showProgress() {
            const progressSection = document.getElementById('progressSection');
            if (progressSection) progressSection.classList.add('active');
        }

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            if (!container) return;
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            const container = document.getElementById('logContainer');
            if (container) container.innerHTML = '';
        }

        function selectPeriodType(type) {
            document.querySelectorAll('.period-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.period-inputs').forEach(input => input.classList.remove('active'));
            event.target.classList.add('active');
            const targetInput = document.getElementById(`${type}-inputs`);
            if (targetInput) targetInput.classList.add('active');
        }

        async function loadDatasetsWithElements() {
            try {
                log('Fetching datasets from DHIS2...', 'info');
                showNotification('Loading datasets...', 'info');
                const url = `${state.config.instanceUrl}/api/dataSets.json?fields=id,displayName,name,periodType,dataSetElements[dataElement[id,displayName,name]]&paging=false`;
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error(`Failed to fetch datasets: ${response.status}`);
                const data = await response.json();
                if (!data.dataSets || !Array.isArray(data.dataSets)) {
                    showNotification('No datasets found in response', 'error');
                    return;
                }
                datasetsData = data.dataSets;
                renderAvailableItems(datasetsData);
                renderSelectedItems();
                document.getElementById('availableSearch').style.display = 'block';
                document.getElementById('addAllBtn').style.display = 'block';
                log(`Loaded ${data.dataSets.length} datasets`, 'success');
                showNotification(`Loaded ${data.dataSets.length} datasets`, 'success');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                showNotification(`Failed to load datasets: ${error.message}`, 'error');
            }
        }

        function renderAvailableItems(datasets) {
            const container = document.getElementById('availablePanel');
            let totalElements = 0;
            datasets.forEach(ds => {
                if (ds.dataSetElements) {
                    ds.dataSetElements.forEach(dse => {
                        if (dse.dataElement && !selectedDataElements.has(dse.dataElement.id)) totalElements++;
                    });
                }
            });
            if (totalElements === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">All items have been selected!</div>';
                document.getElementById('availableCount').textContent = '0 items';
                return;
            }
            container.innerHTML = '';
            datasets.forEach(ds => {
                if (!ds.dataSetElements || ds.dataSetElements.length === 0) return;
                const availableElements = ds.dataSetElements.filter(dse => dse.dataElement && !selectedDataElements.has(dse.dataElement.id));
                if (availableElements.length === 0) return;
                const datasetDiv = document.createElement('div');
                datasetDiv.className = 'dataset-item';
                datasetDiv.dataset.id = ds.id;
                const toggle = document.createElement('span');
                toggle.className = 'item-toggle';
                toggle.textContent = '▶';
                toggle.onclick = (e) => { e.stopPropagation(); toggleDatasetExpand(ds.id); };
                const nameSpan = document.createElement('span');
                nameSpan.className = 'item-name';
                const periodType = ds.periodType ? ` (${ds.periodType})` : '';
                nameSpan.textContent = `${ds.displayName || ds.name || ds.id}${periodType} - ${availableElements.length} elements`;
                datasetDiv.appendChild(toggle);
                datasetDiv.appendChild(nameSpan);
                datasetDiv.onclick = (e) => { if (e.target.className !== 'item-toggle') toggleDatasetExpand(ds.id); };
                container.appendChild(datasetDiv);
                const elementsContainer = document.createElement('div');
                elementsContainer.className = 'data-elements-container';
                elementsContainer.id = `elements-${ds.id}`;
                availableElements.forEach(dse => {
                    if (dse.dataElement) {
                        const elementDiv = document.createElement('div');
                        elementDiv.className = 'data-element-item';
                        elementDiv.dataset.id = dse.dataElement.id;
                        elementDiv.dataset.name = (dse.dataElement.displayName || dse.dataElement.name || '').toLowerCase();
                        const elNameSpan = document.createElement('span');
                        elNameSpan.className = 'item-name';
                        elNameSpan.textContent = dse.dataElement.displayName || dse.dataElement.name || dse.dataElement.id;
                        const addBtn = document.createElement('button');
                        addBtn.className = 'add-btn';
                        addBtn.textContent = '+ Add';
                        addBtn.onclick = (e) => { e.stopPropagation(); addItem(dse.dataElement.id); };
                        elementDiv.onclick = () => addItem(dse.dataElement.id);
                        elementDiv.appendChild(elNameSpan);
                        elementDiv.appendChild(addBtn);
                        elementsContainer.appendChild(elementDiv);
                    }
                });
                container.appendChild(elementsContainer);
            });
            document.getElementById('availableCount').textContent = `${totalElements} items`;
        }

        function toggleDatasetExpand(datasetId) {
            const elementsContainer = document.getElementById(`elements-${datasetId}`);
            const toggle = document.querySelector(`.dataset-item[data-id="${datasetId}"] .item-toggle`);
            if (elementsContainer && toggle) {
                if (elementsContainer.classList.contains('expanded')) {
                    elementsContainer.classList.remove('expanded');
                    toggle.textContent = '▶';
                } else {
                    elementsContainer.classList.add('expanded');
                    toggle.textContent = '▼';
                }
            }
        }

        function renderSelectedItems() {
            const container = document.getElementById('selectedPanel');
            const selectedItems = [];
            datasetsData.forEach(ds => {
                if (ds.dataSetElements) {
                    ds.dataSetElements.forEach(dse => {
                        if (dse.dataElement && selectedDataElements.has(dse.dataElement.id)) {
                            selectedItems.push({ id: dse.dataElement.id, name: dse.dataElement.displayName || dse.dataElement.name || dse.dataElement.id, datasetName: ds.displayName || ds.name || ds.id });
                        }
                    });
                }
            });
            if (selectedItems.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No items selected yet</p>';
                document.getElementById('selectedCount').textContent = '0 items';
                return;
            }
            container.innerHTML = '';
            selectedItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'selected-item';
                itemDiv.dataset.id = item.id;
                itemDiv.dataset.name = item.name.toLowerCase();
                const nameSpan = document.createElement('span');
                nameSpan.className = 'item-name';
                nameSpan.textContent = item.name;
                nameSpan.title = `From: ${item.datasetName}`;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '×';
                removeBtn.onclick = (e) => { e.stopPropagation(); removeItem(item.id); };
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(removeBtn);
                container.appendChild(itemDiv);
            });
            document.getElementById('selectedCount').textContent = `${selectedItems.length} items`;
        }

        function addItem(itemId) { selectedDataElements.add(itemId); renderAvailableItems(datasetsData); renderSelectedItems(); }
        function removeItem(itemId) { selectedDataElements.delete(itemId); renderAvailableItems(datasetsData); renderSelectedItems(); }
        function addAllItems() { datasetsData.forEach(ds => { if (ds.dataSetElements) { ds.dataSetElements.forEach(dse => { if (dse.dataElement) selectedDataElements.add(dse.dataElement.id); }); } }); renderAvailableItems(datasetsData); renderSelectedItems(); }
        function clearAllItems() { selectedDataElements.clear(); renderAvailableItems(datasetsData); renderSelectedItems(); }

        function filterAvailableItems() {
            const searchTerm = document.getElementById('availableSearch').value.toLowerCase();
            const datasets = document.querySelectorAll('#availablePanel .dataset-item');
            datasets.forEach(datasetDiv => {
                const datasetId = datasetDiv.dataset.id;
                const elementsContainer = document.getElementById(`elements-${datasetId}`);
                if (!elementsContainer) return;
                const elements = elementsContainer.querySelectorAll('.data-element-item');
                let hasVisibleElements = false;
                elements.forEach(element => {
                    const name = element.dataset.name;
                    if (name && name.includes(searchTerm)) { element.style.display = 'flex'; hasVisibleElements = true; } 
                    else { element.style.display = 'none'; }
                });
                const datasetName = datasetDiv.querySelector('.item-name').textContent.toLowerCase();
                if (datasetName.includes(searchTerm) || hasVisibleElements) {
                    datasetDiv.style.display = 'flex';
                    if (hasVisibleElements && searchTerm) { elementsContainer.classList.add('expanded'); const toggle = datasetDiv.querySelector('.item-toggle'); if (toggle) toggle.textContent = '▼'; }
                } else { datasetDiv.style.display = 'none'; }
            });
        }

        function filterSelectedItems() {
            const searchTerm = document.getElementById('selectedSearch').value.toLowerCase();
            document.querySelectorAll('#selectedPanel .selected-item').forEach(item => {
                const name = item.dataset.name;
                item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        async function loadOrgUnitsTree() {
            try {
                log('Fetching organisation units...', 'info');
                showNotification('Loading organisation units...', 'info');
                const url = `${state.config.instanceUrl}/api/organisationUnits.json?fields=id,displayName,level,parent[id],children[id]&paging=false`;
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to fetch organisation units');
                const data = await response.json();
                orgUnitsData = data.organisationUnits;
                const tree = buildOrgUnitTree(orgUnitsData);
                renderOrgUnitTree(tree);
                log(`Loaded ${orgUnitsData.length} organisation units`, 'success');
                showNotification(`Loaded ${orgUnitsData.length} organisation units`, 'success');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                showNotification('Failed to load organisation units', 'error');
            }
        }

        function buildOrgUnitTree(orgUnits) {
            const orgUnitMap = {};
            const rootUnits = [];
            orgUnits.forEach(ou => { orgUnitMap[ou.id] = { ...ou, children: [] }; });
            orgUnits.forEach(ou => {
                if (ou.parent && orgUnitMap[ou.parent.id]) { orgUnitMap[ou.parent.id].children.push(orgUnitMap[ou.id]); } 
                else { rootUnits.push(orgUnitMap[ou.id]); }
            });
            return rootUnits;
        }

        function renderOrgUnitTree(tree) {
            const container = document.getElementById('orgUnitTree');
            container.innerHTML = '';
            tree.forEach(ou => container.appendChild(createOrgUnitNode(ou)));
        }

        function createOrgUnitNode(orgUnit) {
            const div = document.createElement('div');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'org-unit-item';
            itemDiv.dataset.id = orgUnit.id;
            const toggle = document.createElement('span');
            toggle.className = 'org-unit-toggle';
            if (orgUnit.children && orgUnit.children.length > 0) { toggle.textContent = '▶'; toggle.onclick = (e) => { e.stopPropagation(); toggleOrgUnit(orgUnit.id); }; } 
            else { toggle.textContent = '  '; toggle.style.cursor = 'default'; }
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'org-unit-checkbox';
            checkbox.dataset.id = orgUnit.id;
            checkbox.checked = selectedOrgUnits.has(orgUnit.id);
            checkbox.onchange = (e) => { e.stopPropagation(); toggleOrgUnitSelection(orgUnit.id, e.target.checked); };
            const label = document.createElement('span');
            label.className = 'org-unit-label';
            label.textContent = orgUnit.displayName;
            label.onclick = () => { checkbox.checked = !checkbox.checked; toggleOrgUnitSelection(orgUnit.id, checkbox.checked); };
            itemDiv.appendChild(toggle);
            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(label);
            div.appendChild(itemDiv);
            if (orgUnit.children && orgUnit.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'org-unit-children';
                childrenDiv.id = `children-${orgUnit.id}`;
                orgUnit.children.forEach(child => { childrenDiv.appendChild(createOrgUnitNode(child)); });
                div.appendChild(childrenDiv);
            }
            return div;
        }

        function toggleOrgUnit(id) {
            const childrenDiv = document.getElementById(`children-${id}`);
            const toggle = document.querySelector(`[data-id="${id}"] .org-unit-toggle`);
            if (childrenDiv.classList.contains('expanded')) { childrenDiv.classList.remove('expanded'); toggle.textContent = '▶'; } 
            else { childrenDiv.classList.add('expanded'); toggle.textContent = '▼'; }
        }

        function toggleOrgUnitSelection(id, selected) {
            if (selected) { selectedOrgUnits.add(id); } else { selectedOrgUnits.delete(id); }
            const item = document.querySelector(`.org-unit-item[data-id="${id}"]`);
            if (item) { if (selected) { item.classList.add('selected'); } else { item.classList.remove('selected'); } }
        }

        function expandAllOrgUnits() { document.querySelectorAll('.org-unit-children').forEach(div => div.classList.add('expanded')); document.querySelectorAll('.org-unit-toggle').forEach(toggle => { if (toggle.textContent === '▶') toggle.textContent = '▼'; }); }
        function collapseAllOrgUnits() { document.querySelectorAll('.org-unit-children').forEach(div => div.classList.remove('expanded')); document.querySelectorAll('.org-unit-toggle').forEach(toggle => { if (toggle.textContent === '▼') toggle.textContent = '▶'; }); }
        function selectAllOrgUnits() { document.querySelectorAll('.org-unit-checkbox').forEach(checkbox => { checkbox.checked = true; selectedOrgUnits.add(checkbox.dataset.id); }); document.querySelectorAll('.org-unit-item').forEach(item => item.classList.add('selected')); }
        function clearAllOrgUnits() { document.querySelectorAll('.org-unit-checkbox').forEach(checkbox => checkbox.checked = false); selectedOrgUnits.clear(); document.querySelectorAll('.org-unit-item').forEach(item => item.classList.remove('selected')); }

        function getPeriodFromForm() {
            const activeTab = document.querySelector('.period-tab.active');
            if (!activeTab) return '';
            const tabText = activeTab.textContent.trim().toLowerCase();
            if (tabText === 'monthly') {
                const periodInput = document.querySelector('#monthly-inputs input[name="period"]');
                const period = periodInput?.value;
                if (period) return `period=${period.replace('-', '')}`;
            } else if (tabText === 'date range') {
                const startInput = document.querySelector('#range-inputs input[name="periodStart"]');
                const endInput = document.querySelector('#range-inputs input[name="periodEnd"]');
                const start = startInput?.value;
                const end = endInput?.value;
                if (start && end) return `startDate=${start}&endDate=${end}`;
            } else if (tabText === 'quarterly') {
                const yearInput = document.querySelector('#quarterly-inputs input[name="year"]');
                const quarterSelect = document.querySelector('#quarterly-inputs select[name="quarter"]');
                const year = yearInput?.value;
                const quarter = quarterSelect?.value;
                if (year && quarter) return `period=${year}${quarter}`;
            } else if (tabText === 'yearly') {
                const startYearInput = document.querySelector('#yearly-inputs input[name="startYear"]');
                const endYearInput = document.querySelector('#yearly-inputs input[name="endYear"]');
                const startYear = startYearInput?.value;
                const endYear = endYearInput?.value;
                if (startYear && endYear) return `startDate=${startYear}-01-01&endDate=${endYear}-12-31`;
                else if (startYear) return `period=${startYear}`;
            }
            return '';
        }

        async function executeDownloadDatasets() {
            const selectedDataElementIds = Array.from(selectedDataElements);
            const selectedOrgUnitIds = Array.from(selectedOrgUnits);
            if (selectedDataElementIds.length === 0) { showNotification('Please select at least one data element', 'error'); return; }
            if (selectedOrgUnitIds.length === 0) { showNotification('Please select at least one organisation unit', 'error'); return; }
            const downloadBtn = document.getElementById('downloadDatasetsBtn');
            if (downloadBtn) { downloadBtn.disabled = true; downloadBtn.textContent = 'Processing...'; }
            showProgress();
            clearLogs();
            setProgress(0);
            try {
                log(`Processing ${selectedDataElementIds.length} selected data elements...`, 'info');
                setProgress(20);
                const dataElementMap = {};
                datasetsData.forEach(ds => {
                    if (ds.dataSetElements) {
                        ds.dataSetElements.forEach(dse => {
                            if (dse.dataElement && selectedDataElementIds.includes(dse.dataElement.id)) {
                                dataElementMap[dse.dataElement.id] = dse.dataElement.displayName || dse.dataElement.name || dse.dataElement.id;
                            }
                        });
                    }
                });
                log(`Prepared ${Object.keys(dataElementMap).length} data elements for export`, 'success');
                const orgUnitMap = {};
                const orgUnitHierarchy = {};
                log('Building organisation unit hierarchy...', 'info');
                setProgress(40);
                orgUnitsData.forEach(ou => {
                    orgUnitMap[ou.id] = ou.displayName;
                    orgUnitHierarchy[ou.id] = { id: ou.id, name: ou.displayName, level: ou.level, parent: ou.parent ? ou.parent.id : null };
                });
                const period = getPeriodFromForm();
                if (!period) { showNotification('Please select a period', 'error'); if (downloadBtn) { downloadBtn.disabled = false; downloadBtn.textContent = 'DOWNLOAD DATASET DATA'; } return; }
                log('Fetching data values...', 'info');
                log(`  Data Elements: ${selectedDataElementIds.length}`, 'info');
                log(`  Org Units: ${selectedOrgUnitIds.length}`, 'info');
                log(`  Period: ${period}`, 'info');
                setProgress(60);
                const dataUrl = `${state.config.instanceUrl}/api/dataValueSets.json?dataElement=${selectedDataElementIds.join(',')}&orgUnit=${selectedOrgUnitIds.join(',')}&${period}`;
                const dataResponse = await fetchWithAuth(dataUrl);
                if (!dataResponse.ok) throw new Error('Failed to fetch data values');
                const dataValues = await dataResponse.json();
                const numValues = dataValues.dataValues?.length || 0;
                log(`Retrieved ${numValues} data values`, 'success');
                setProgress(80);
                
                // Get all periods for the export (for generating all combinations)
                const allPeriods = new Set();
                if (dataValues.dataValues) {
                    dataValues.dataValues.forEach(dv => allPeriods.add(dv.period));
                }
                const periodsArray = Array.from(allPeriods).sort();
                
                if (numValues === 0) {
                    showNotification('No data values found for selected criteria', 'info');
                    log('No data found. This could mean:', 'info');
                    log('   - No data entered for this period', 'info');
                    log('   - Selected org units have no data', 'info');
                    log('   - Data elements are not used in this period', 'info');
                    if (downloadBtn) { downloadBtn.disabled = false; downloadBtn.textContent = 'DOWNLOAD DATASET DATA'; }
                    return;
                }
                log('Fetching category option combos...', 'info');
                const categoryOptionComboMap = {};
                const cocUrl = `${state.config.instanceUrl}/api/categoryOptionCombos.json?fields=id,displayName,name&paging=false`;
                const cocResponse = await fetchWithAuth(cocUrl);
                if (cocResponse.ok) {
                    const cocData = await cocResponse.json();
                    cocData.categoryOptionCombos?.forEach(coc => { categoryOptionComboMap[coc.id] = coc.displayName || coc.name || coc.id; });
                    log(`  Found ${Object.keys(categoryOptionComboMap).length} category combos`, 'info');
                }
                log('Converting to wide format CSV...', 'info');
                const csvData = convertToWideFormatCSV(dataValues.dataValues, dataElementMap, orgUnitMap, categoryOptionComboMap, orgUnitHierarchy, selectedOrgUnitIds, periodsArray);
                const blob = new Blob([csvData], { type: 'text/csv' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `dataset-export-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                setProgress(100);
                log('═══════════════════════════════════════', 'success');
                log('DOWNLOAD COMPLETE!', 'success');
                log('═══════════════════════════════════════', 'success');
                log(`  ${numValues} data values exported`, 'success');
                log(`  ${selectedDataElementIds.length} data elements`, 'success');
                log(`  ${selectedOrgUnitIds.length} organisation units`, 'success');
                showNotification('Dataset data downloaded successfully!', 'success');
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                if (downloadBtn) { downloadBtn.disabled = false; downloadBtn.textContent = 'DOWNLOAD DATASET DATA'; }
            }
        }

        function convertToWideFormatCSV(dataValues, dataElementMap, orgUnitMap, categoryOptionComboMap, orgUnitHierarchy, selectedOrgUnitIds, periodsArray) {
            log(`Converting ${dataValues.length} data values to wide format...`, 'info');
            
            // Group data by orgUnit|period key
            const groupedData = {};
            dataValues.forEach(dv => {
                const key = `${dv.orgUnit}|${dv.period}`;
                if (!groupedData[key]) { groupedData[key] = { orgUnit: dv.orgUnit, period: dv.period, values: {} }; }
                const deName = dataElementMap[dv.dataElement] || dv.dataElement;
                const cocName = categoryOptionComboMap[dv.categoryOptionCombo] || dv.categoryOptionCombo || 'default';
                let fullKey = deName;
                if (cocName !== 'default' && cocName !== dv.categoryOptionCombo) { fullKey = `${deName} (${cocName})`; }
                groupedData[key].values[fullKey] = dv.value;
            });
            
            // Get all columns
            const allColumns = new Set();
            Object.values(groupedData).forEach(row => { Object.keys(row.values).forEach(col => allColumns.add(col)); });
            const sortedColumns = Array.from(allColumns).sort();
            
            // Calculate max hierarchy level
            let maxLevel = 0;
            Object.values(orgUnitHierarchy).forEach(ou => { if (ou.level > maxLevel) maxLevel = ou.level; });
            const hierarchyHeaders = [];
            for (let i = 1; i <= maxLevel; i++) { hierarchyHeaders.push(`Level ${i}`); }
            
            const headers = [...hierarchyHeaders, 'Period', ...sortedColumns];
            let csv = headers.join(',') + '\n';
            
            // Generate ALL combinations of selected org units × periods (include empty rows)
            selectedOrgUnitIds.forEach(ouId => {
                periodsArray.forEach(period => {
                    const key = `${ouId}|${period}`;
                    const rowData = groupedData[key] || { orgUnit: ouId, period: period, values: {} };
                    const csvRow = [];
                    const hierarchy = getOrgUnitHierarchy(ouId, orgUnitHierarchy);
                    for (let i = 0; i < maxLevel; i++) { csvRow.push(escapeCSV(hierarchy[i] || '')); }
                    csvRow.push(escapeCSV(period));
                    sortedColumns.forEach(col => { csvRow.push(escapeCSV(rowData.values[col] || '')); });
                    csv += csvRow.join(',') + '\n';
                });
            });
            
            log('Wide format CSV conversion complete', 'success');
            return csv;
        }

        function getOrgUnitHierarchy(orgUnitId, orgUnitHierarchy) {
            const hierarchy = [];
            let current = orgUnitHierarchy[orgUnitId];
            while (current) { hierarchy.unshift(current.name); current = current.parent ? orgUnitHierarchy[current.parent] : null; }
            return hierarchy;
        }

        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) { return '"' + stringValue.replace(/"/g, '""') + '"'; }
            return stringValue;
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const instanceUrl = document.getElementById('instanceUrl').value.trim().replace(/\/$/, '');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            const submitBtn = e.target.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Connecting...';
            
            const config = { instanceUrl, username, password };
            try {
                showNotification('Connecting via proxy...', 'info');
                const testUrl = `${instanceUrl}/api/me`;
                const authHeader = 'Basic ' + btoa(`${username}:${password}`);
                const response = await makeProxyRequest(testUrl, { method: 'GET', headers: { 'Authorization': authHeader } });
                if (response.ok) {
                    const userData = await response.json();
                    state.config = config;
                    state.isLoggedIn = true;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainContent').classList.add('active');
                    const firstName = userData.firstName || '';
                    const surname = userData.surname || '';
                    const fullName = `${firstName} ${surname}`.trim() || 'User';
                    showNotification(`Connected successfully! Welcome ${fullName}`, 'success');
                } else if (response.status === 401) {
                    showNotification('Invalid username or password', 'error');
                } else if (response.status === 403) {
                    showNotification('Access forbidden', 'error');
                } else {
                    showNotification(`Authentication failed (${response.status})`, 'error');
                }
            } catch (error) {
                showNotification(`Connection failed: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Connect to DHIS2';
            }
        });
    </script>
</body>
</html>
